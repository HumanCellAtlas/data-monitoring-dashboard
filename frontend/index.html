<h3>HCA DCP Internal Tracker</h3>
<p>Data refreshed every 3 hours</p>
<html style="padding:5px;">
<link rel="stylesheet" href="tracker.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.3/css/foundation.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.foundation.min.css">
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<div class="lds-ring"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
<table id="tracker" class="display hover" style="display:none">
        <thead>
            <tr>
                <th colspan="6">Project Info</th>
                <th colspan="4">Primary Data</th>
                <th colspan="7">Analysis Data</th>
            </tr>
            <tr>
                <th>Project Title</th>
                <th>Submission Date</th>
                <th>Project UUID</th>
                <th>Ingest Submission Id</th>
                <th>Species</th>
                <th>Method</th>
                <th>Ingest Submission Status</th>
                <th>Ingest Primary Bundles Exported</th>
                <th>DSS Primary Bundles</th>
                <th>Azul Primary Bundles</th>
                <th>Analysis Workflows By Status</th>
                <th>Analysis Workflows By Pipeline Version</th>
                <th>DSS Analysis Bundles</th>
                <th>Azul Analysis Bundles</th>
                <th>Matrix Analysis Bundles</th>
                <th>Matrix Cell Count</th>
                <th>Project Short Name</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th>Project Title</th>
                <th>Submission Date</th>
                <th>Project UUID</th>
                <th>Ingest Submission Id</th>
                <th>Species</th>
                <th>Methods</th>
                <th>Ingest Submission Status</th>
                <th>Ingest Primary Bundles Exported</th>
                <th>DSS Primary Bundles</th>
                <th>Azul Primary Bundles</th>
                <th>Analysis Workflows By Status</th>
                <th>Analysis Workflows By Pipeline Version</th>
                <th>DSS Analysis Bundles</th>
                <th>Azul Analysis Bundles</th>
                <th>Matrix Analysis Bundles</th>
                <th>Matrix Cell Count</th>
                <th>Project Short Name</th>
            </tr>
        </tfoot>
    </table>
<p id='github_link' style="display:none">Please report issues or suggestions in <a target='_blank' href='https://github.com/HumanCellAtlas/data-monitoring-dashboard/issues'>github</a></p>
<script>
String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1)
}

var small = function(str){
    return '<small>' + str + '</small>'
}

var convert_to_red_div = function(str){
    return '<div class="red">' + str + '</div>'
}

var convert_to_green_div = function(str){
    return '<div class="green">' + str + '</div'
}

$(document).ready(function() {
    var currentUrl = location.protocol + '//' + location.host + location.pathname
    var getTrackerApiUrl = function(){
        apiUrl = currentUrl.replace('tracker', 'tracker-api')
        return apiUrl
    }

    var getProjectTrackerUrl = function(projectUUID){
        projectTrackerUrl = currentUrl + '?projectUUID=' + projectUUID
        return projectTrackerUrl
    }
    var dataSet = []
    projectsApiEndpoint = getTrackerApiUrl() + 'v0/projects'
    $.getJSON(projectsApiEndpoint, function(data) {
      $.each( data, function(key, val) {
        var projectUUID = key
        
        ingest_info = val['ingest-info']
        azul_info = val['azul-info']
        dss_info = val['dss-info']
        matrix_info = val['matrix-info']
        analysis_info = val['analysis-info']

        // PROJECT INFO DISPLAY
        var lastUpdatedAt = new Date(azul_info['updated_at']).toLocaleString()
        var submissionDate = new Date(ingest_info['submission_date']).toISOString().substring(0, 10);
        var projectLinkButton = "<button data-id='" + projectUUID + "' class='copy-button'>Shareable link</button>"
        var projectTitle = '<b>' + ingest_info['project_title'] + '</b><br><small>Stats refreshed at: ' + lastUpdatedAt + projectLinkButton
        var projectShortName = '<b>' + ingest_info['project_short_name'] + '</b><br><small>Stats refreshed at: ' + lastUpdatedAt
        var submissionId = ingest_info['submission_id']
        var species = ingest_info['species']
        var methods = ingest_info['library_construction_methods']

        // PRIMARY INFO DISPLAY
        var submissionStatus = ingest_info['submission_status']
        if(submissionStatus != 'Complete'){
            submissionStatus = convert_to_red_div(small(submissionStatus))
        }
        else {
            submissionStatus = convert_to_green_div(small(submissionStatus))
        }
        var ingestPrimaryBundleCount = ingest_info['submission_bundles_exported_count']
        // This submission has the incorrect bundle count but has been resolved. Manually overriding.
        if(submissionId == '5cda8757d96dad000856d2ae'){
            ingestPrimaryBundleCount = '3514'
        }

        if(parseInt(ingestPrimaryBundleCount) == 0){
            ingestPrimaryBundleCountDisplay = convert_to_red_div(small(ingestPrimaryBundleCount))
        }
        else {
            ingestPrimaryBundleCountDisplay = convert_to_green_div(small(ingestPrimaryBundleCount))
        }

        var dssAwsPrimaryBundleCount = dss_info['aws_primary_bundle_count']
        var dssAwsAnalysisBundleCount = dss_info['aws_analysis_bundle_count']
        var dssGcpPrimaryBundleCount = dss_info['gcp_primary_bundle_count']
        var dssGcpAnalysisBundleCount = dss_info['gcp_analysis_bundle_count']
        var dssPrimaryBundleCountDisplay = "AWS: " + dssAwsPrimaryBundleCount + "<br>GCP: " + dssGcpPrimaryBundleCount
        var dssAnalysisBundleCountDisplay = "AWS: " + dssAwsAnalysisBundleCount + "<br>GCP: " + dssGcpAnalysisBundleCount
        if(parseInt(dssAwsPrimaryBundleCount) != parseInt(ingestPrimaryBundleCount) || parseInt(dssGcpPrimaryBundleCount) != parseInt(ingestPrimaryBundleCount)){
            dssPrimaryBundleCountDisplay = convert_to_red_div(small(dssPrimaryBundleCountDisplay))
        }
        else {
            dssPrimaryBundleCountDisplay = convert_to_green_div(small(dssPrimaryBundleCountDisplay))
        }

        // ANALYSIS INFO DISPLAY
        var project_workflows_job_manager_link_template = 'https://job-manager.caas-prod.broadinstitute.org/jobs?q=project_uuid%3D{PROJECT_UUID}'
        var project_and_status_job_manager_link_template = 'https://job-manager.caas-prod.broadinstitute.org/jobs?q=project_uuid%3D{PROJECT_UUID}%26status%3D{WORKFLOW_STATUS}'
        var project_and_version_job_manager_link_template = 'https://job-manager.caas-prod.broadinstitute.org/jobs?q=project_uuid%3D{PROJECT_UUID}%26workflow-version%3D{WORKFLOW_VERSION}'
        var workflowLink = project_workflows_job_manager_link_template.replace('{PROJECT_UUID}', projectUUID)
        var workflowStatsByStatusDisplay = '<a href="' + workflowLink + '"target="_blank">' + 'Total: ' + analysis_info['total_workflows'] + '</a>' + '<br>'
        var workflowStatsByVersionDisplay = '<a href="' + workflowLink + '"target="_blank">' + 'Total: ' + analysis_info['total_workflows'] + '</a>' + '<br>'
        $.each(analysis_info, function( key, val ) {
            if(key.includes('_workflows') && key != 'total_workflows'){
                var workflowStatus = key.split('_workflows')[0].capitalize()
                var workflowLink = project_and_status_job_manager_link_template.replace('{PROJECT_UUID}', projectUUID).replace('{WORKFLOW_STATUS}', workflowStatus)
                var worfklowStatusMessage = '<a href="' + workflowLink + '"target="_blank">' + workflowStatus + ': ' + val + '</a>'
                workflowStatsByStatusDisplay = workflowStatsByStatusDisplay + worfklowStatusMessage + '<br>'
            }
            else if(key != 'total_workflows' && key != 'updated_at' && key != 'project_uuid'){
                var workflowLink = project_and_version_job_manager_link_template.replace('{PROJECT_UUID}', projectUUID).replace('{WORKFLOW_VERSION}', key)
                var worfklowVersionMessage = '<a href="' + workflowLink + '"target="_blank">' + key + ': ' + val + '</a>'
                workflowStatsByVersionDisplay = workflowStatsByVersionDisplay + worfklowVersionMessage + '<br>'
            }
        })
        if(parseInt(analysis_info['total_workflows']) > 0 && parseInt(analysis_info['succeeded_workflows']) < dssGcpPrimaryBundleCount) {
            workflowStatsByStatusDisplay = convert_to_red_div(small(workflowStatsByStatusDisplay))
        }
        else if (parseInt(analysis_info['total_workflows']) > 0 && analysis_info['succeeded_workflows'] == undefined){
            workflowStatsByStatusDisplay = convert_to_red_div(small(workflowStatsByStatusDisplay))
        }
        else {
            workflowStatsByStatusDisplay = convert_to_green_div(small(workflowStatsByStatusDisplay))
        }

        if (parseInt(analysis_info['total_workflows']) > 0 && analysis_info['succeeded_workflows'] != undefined){
            if(parseInt(dssAwsAnalysisBundleCount) != parseInt(dssGcpPrimaryBundleCount)){
                dssAnalysisBundleCountDisplay = convert_to_red_div(small(dssAnalysisBundleCountDisplay))
            }
            else if(parseInt(dssAwsAnalysisBundleCount) != parseInt(dssGcpAnalysisBundleCount)){
                dssAnalysisBundleCountDisplay = convert_to_red_div(small(dssAnalysisBundleCountDisplay))
            }
            else {
                dssAnalysisBundleCountDisplay = convert_to_green_div(small(dssAnalysisBundleCountDisplay))
            }
        }
        else {
            dssAnalysisBundleCountDisplay = convert_to_green_div(small(dssAnalysisBundleCountDisplay))
        }

        var azulPrimaryBundleCount = azul_info['primary_bundle_count']
        var azulAnalysisBundleCount = azul_info['analysis_bundle_count']
        if(parseInt(azulPrimaryBundleCount) != parseInt(dssAwsPrimaryBundleCount)){
            azulPrimaryBundleCountDisplay = convert_to_red_div(small(azulPrimaryBundleCount))
        }
        else {
            azulPrimaryBundleCountDisplay = convert_to_green_div(small(azulPrimaryBundleCount))
        }
        if(parseInt(azulAnalysisBundleCount) != parseInt(dssAwsAnalysisBundleCount)){
            azulAnalysisBundleCountDisplay = convert_to_red_div(small(azulAnalysisBundleCount))
        }
        else {
            azulAnalysisBundleCountDisplay = convert_to_green_div(small(azulAnalysisBundleCount))
        }

        matrix_info = val['matrix-info']
        var matrixAnalysisBundleCount = matrix_info['analysis_bundle_count']
        var matrixCellCount = matrix_info['cell_count']

        if(parseInt(matrixAnalysisBundleCount) != parseInt(dssAwsAnalysisBundleCount)){
            matrixAnalysisBundleCountDisplay = convert_to_red_div(small(matrixAnalysisBundleCount))
            matrixCellCountDisplay = convert_to_red_div(small(matrixCellCount))
        }
        else {
            matrixAnalysisBundleCountDisplay = convert_to_green_div(small(matrixAnalysisBundleCount))
            matrixCellCountDisplay = convert_to_green_div(small(matrixCellCount))
        }

        var project = [
            convert_to_green_div(projectTitle), 
            convert_to_green_div(small(submissionDate)),
            convert_to_green_div(small(projectUUID)), 
            convert_to_green_div(small(submissionId)),
            convert_to_green_div(small(species)),
            convert_to_green_div(small(methods)),
            submissionStatus,
            ingestPrimaryBundleCountDisplay,
            dssPrimaryBundleCountDisplay,
            azulPrimaryBundleCountDisplay,
            workflowStatsByStatusDisplay,
            convert_to_green_div(small(workflowStatsByVersionDisplay)),
            dssAnalysisBundleCountDisplay,
            azulAnalysisBundleCountDisplay,
            matrixAnalysisBundleCountDisplay,
            matrixCellCountDisplay,
            convert_to_green_div(projectShortName)
        ]

        if(parseInt(dssAwsPrimaryBundleCount) > 0 || parseInt(dssAwsAnalysisBundleCount) > 0 || parseInt(dssGcpPrimaryBundleCount) > 0 || parseInt(dssGcpAnalysisBundleCount) > 0 || parseInt(azulPrimaryBundleCount) > 0 || parseInt(azulAnalysisBundleCount) > 0 || parseInt(matrixAnalysisBundleCount) > 0) {
            dataSet.push(project);
        }
      });
      jQuery.extend( jQuery.fn.dataTableExt.oSort, {
        "num-html-pre": function ( a ) {
            var x = String(a).replace( /<[\s\S]*?>/g, "" );
            return parseFloat( x );
        },
        "num-html-asc": function ( a, b ) {
            return ((a < b) ? -1 : ((a > b) ? 1 : 0));
        },
        "num-html-desc": function ( a, b ) {
            return ((a < b) ? 1 : ((a > b) ? -1 : 0));
        }
      });
      function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
        });
        return vars;
      }
      function getUrlParam(parameter, defaultvalue){
        var urlparameter = defaultvalue;
        if(window.location.href.indexOf(parameter) > -1){
          urlparameter = getUrlVars()[parameter];
        }
        return urlparameter;
      }
      $('#tracker').DataTable({
        oSearch: {"sSearch": getUrlParam('projectUUID', '')},
        paging: false,
        data: dataSet,
        order: [[ 1, "desc" ]],
        columnDefs: [
            {
               targets: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16],
               className: 'dt-left'
            },
            { type: 'num-html', targets: [7, 9, 13, 14, 15] }
        ],
        drawCallback: function( settings ) {
            $('.red').parent('.dt-left').css('background', '#f5dad6');
            $('.red').parent('.dt-left').prop('title', 'Unexpected value found. Further Investigation required');
            $('.copy-button').on('click', function () {
                var projectUUID = $(this).data('id')
                projectTrackerUrl = getProjectTrackerUrl(projectUUID)
                alert("Copy this url: " + projectTrackerUrl);
            });
        }
      });
      $('#tracker_filter').css("color", "#b92525");
      $('#tracker_filter').css("font-size", "25px");
      $('#tracker_filter').css("float", "left");
      $('#tracker_length').css("float", "right");
      $('input').css("width", "300px");
      $('.lds-ring').hide();
      $('#tracker').show();
      $('#github_link').show();
    });
})
</script>

</html>
